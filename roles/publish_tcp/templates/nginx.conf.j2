load_module modules/ngx_stream_module.so;


worker_processes auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections 1024;
}

stream {
{% for rule in proxy_rules %}
  upstream backend_{{ loop.index }} {
  {% if rule.hosts is defined %}
    {# expand all hosts in the Ansible group #}
    {% for h in groups[rule.hosts] %}
    server {{ hostvars[h].ansible_host | default(h) }}:{{ rule.destination_port }};
    {% endfor %}
  {% else %}
    server 127.0.0.1:{{ rule.destination_port }};
  {% endif %}
  }

  server {
    listen {{ hostvars[inventory_hostname].ansible_host }}:{{ rule.source_port }};
    proxy_pass backend_{{ loop.index }};
  {% for cidr in rule.cidrs %}
    allow {{ cidr }};
  {% endfor %}
    deny all;
  }
{% endfor %}
}